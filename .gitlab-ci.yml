include:
   -  template: Terraform/Base.gitlab-ci.yml

variables:
   # This will suppress any download for dependencies and plugins or upload messages which would clutter the console log.
   # `showDateTime` will show the passed time in milliseconds. You need to specify `--batch-mode` to make this work.
   MAVEN_OPTS: "-Dmaven.repo.local=.m2/repository -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=WARN -Dorg.slf4j.simpleLogger.showDateTime=true -Djava.awt.headless=true"
   # As of Maven 3.3.0 instead of this you may define these options in `.mvn/maven.config` so the same config is used
   # when running from the command line.
   # `installAtEnd` and `deployAtEnd` are only effective with recent version of the corresponding plugins.
   MAVEN_CLI_OPTS: "--batch-mode --errors --fail-at-end --show-version -DinstallAtEnd=true -DdeployAtEnd=true -U"
   # Used during gitflow interaction.
   MAJOR_RELEASE_DIGIT: 0
   MINOR_RELEASE_DIGIT: 1
   PATCH_RELEASE_DIGIT: 2

   # https://docs.gitlab.com/ee/ci/large_repositories/#shallow-cloning
   GIT_DEPTH: 10

   TF_STATE_NAME_DEV: dev
   TF_STATE_NAME_PROD: prod

.git_template: &git_setup |
   git remote set-url --push origin "https://oauth2:${GITLAB_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git"
   git config user.name "vyne-cd"
   git config user.email vyne-cd@vyne.co


stages:
   - build
   - publish
   - deploy
   - verify
   - release

default:
   tags:
      - docker

.build-jvm:
   stage: build
   image: ${CI_DEPENDENCY_PROXY_GROUP_IMAGE_PREFIX}/maven:3.8.6-eclipse-temurin-18
   tags:
      - docker-heavy
   cache:
      paths:
         - .m2/repository
   script:
      # Do the "docker login" manually as there's no Docker CLI installed on maven images
      - |
         mkdir /root/.docker/
         cat > /root/.docker/config.json << EOF
         {
             "auths": {
                 "https://index.docker.io/v1/": {
                     "username": "vynecd",
                     "password": "${DOCKER_HUB_PASSWORD}",
                     "auth": "$(echo -n 'vynecd:${DOCKER_HUB_PASSWORD}' | base64)"
                 }
             }
         }
         EOF
      - 'if [ -z "${GITLAB_TOKEN}" ]; then echo "var is blank"; else echo "var is set"; fi'
      - 'if [ -z "${CI_SERVER_HOST}" ]; then echo "var is blank"; else echo "var is set"; fi'
      - 'if [ -z "${CI_PROJECT_PATH}" ]; then echo "var is blank"; else echo "var is set"; fi'
      - 'mvn $MAVEN_CLI_OPTS -version'
      - 'mvn $MAVEN_CLI_OPTS -T1C -DbuildNumber=$CI_JOB_ID $MAVEN_EXTRA_ARGS -P fastTestsOnly $MAVEN_GOALS'
      - 'mvn $MAVEN_CLI_OPTS -DbuildNumber=$CI_JOB_ID $MAVEN_EXTRA_ARGS -pl vyne-history-core,pipelines/pipeline-jet,vyne-analytics-server test'

      #   Read the POM, grab the version, and set to an env variable
      #   https://stackoverflow.com/a/52241594
      # Run the actual command twice.  The first time ensures that any downloads are
      # already completed, so that when we try to grep the output string, we get a tidy predictable output
      - mvn --non-recursive help:evaluate -Dexpression=project.version
      - mvn --non-recursive help:evaluate -Dexpression=project.version | grep -v '\[.*' > build-version.txt
   artifacts:
      paths:
         - build-version.txt

         # Be careful!  The each of these jar files can get big.
         # If the total size of all jar files being stored in artifacts
         # exceeds 1GB then builds can fail.
         #         - "cask/target/cask.jar"
         - "pipelines/pipeline-jet/target/pipeline-jet.jar"
         - "schema-server/target/schema-server.jar"
         - "vyne-analytics-server/target/vyne-analytics-server.jar"
         - "query-node-native/target/query-node-native.jar"
         - "vyne-query-service/target/vyne.zip"
#         - "station/target/orbital.zip"
         - "test-cli/target/*.zip"
#         - "voyager/target/voyager.jar"
      expire_in: 1 hours
      reports:
         junit:
            # Note:This won't actually work, b/c of https://gitlab.com/gitlab-org/gitlab-runner/issues/2620
            # However, leaving this here to pick up later
            - "*/target/surefire-reports/TEST-*.xml"

.build-ui:
   stage: build
   image: ${CI_DEPENDENCY_PROXY_GROUP_IMAGE_PREFIX}/node:16.14
   before_script:
      - npm config set cache .npm/cache --global
      - npm --global cache verify
      - npm get cache
      - export NODE_OPTIONS="--max-old-space-size=8192"
   cache:
      paths:
         - .npm/cache
   tags:
      - docker-heavy

build-vyne-ui:
   extends: .build-ui
   script:
      - cd vyne-query-service/src/main/web
      - npm ci
      - npm run-script build-prod
   artifacts:
      paths:
         - vyne-query-service/target/classes/static
      expire_in: 1 hours

build-voyager-ui:
   extends: .build-ui
   script:
      - cd vyne-query-service/src/main/web
      - npm ci
      - npm run-script build-prod-voyager
   artifacts:
      paths:
         - "voyager/target/classes/static"
      expire_in: 1 hours


build-jvm-branch:
   stage: build
   except:
      - tags
      - develop
      - master
   extends: .build-jvm
   variables:
      MAVEN_GOALS: 'clean install'
      MAVEN_EXTRA_ARGS: ''

build-jvm-develop:
   stage: build
   only:
      - develop
   extends: .build-jvm
   variables:
      MAVEN_GOALS: 'clean deploy'
      # We skip tests on develop and master, as the tests have already run on the branch
      MAVEN_EXTRA_ARGS: '-P snapshot-release -DskipTests'


build-jvm-master:
   stage: build
   only:
      - master
   extends: .build-jvm
   variables:
      MAVEN_GOALS: 'clean deploy'
      # We skip tests on develop and master, as the tests have already run on the branch
      MAVEN_EXTRA_ARGS: '-P release -DskipTests'

release-major:
   image: ${CI_DEPENDENCY_PROXY_GROUP_IMAGE_PREFIX}/maven:3.8.6-eclipse-temurin-18
   variables:
      GIT_STRATEGY: clone
   dependencies: [ ]
   stage: release
   script:
      - *git_setup
      - 'mvn gitflow:release -B -DversionDigitToIncrement=$MAJOR_RELEASE_DIGIT -DskipTestProject=true'
   only:
      - develop
   when: manual

release-minor:
   image: ${CI_DEPENDENCY_PROXY_GROUP_IMAGE_PREFIX}/maven:3.8.6-eclipse-temurin-18
   variables:
      GIT_STRATEGY: clone
   dependencies: [ ]
   stage: release
   script:
      - *git_setup
      - 'mvn gitflow:release -B -DversionDigitToIncrement=$MINOR_RELEASE_DIGIT -DskipTestProject=true'
   only:
      - develop
   when: manual

release-patch:
   image: ${CI_DEPENDENCY_PROXY_GROUP_IMAGE_PREFIX}/maven:3.8.6-eclipse-temurin-18
   variables:
      GIT_STRATEGY: clone
   dependencies: [ ]
   stage: release
   script:
      - *git_setup
      - 'mvn gitflow:release -B -DversionDigitToIncrement=$PATCH_RELEASE_DIGIT -DskipTestProject=true'
   only:
      - develop
   when: manual

regression-test:
   stage: verify
   resource_group: docker_release
   variables:
      VYNE_DOCKER_TAG: latest
   script:
      - mvn clean install -DskipTests -Dskip.npm
      - cd regression-tests
      - mvn -Dtest=TaxonomyRegressionTest -Drun.mode=docker -Dvyne.tag=${VYNE_DOCKER_TAG} test
   when: manual
   artifacts:
      when: always
      reports:
         junit:
            - target/surefire-reports/TEST-*.xml


# This creates the multi-platform Docker images
.publish-docker:
   stage: deploy
   image: ${CI_DEPENDENCY_PROXY_GROUP_IMAGE_PREFIX}/jdrouet/docker-with-buildx:20.10.17-0.8.2
   variables:
      DOCKER_BUILDKIT: 1
      BUILDKIT_PROGRESS: plain
      PROGRESS_NO_TRUNC: 1
   script:
      - docker login -u vynecd -p $DOCKER_HUB_PASSWORD
      - PROJECT_VERSION=$(cat build-version.txt)
      - docker buildx create --use
      - docker run --privileged --rm tonistiigi/binfmt --install all # Install the required emulators in order to build ARM images
      - |
         if [[ "$CI_COMMIT_BRANCH" == "master" ]]; then
           tag="latest"
           versionTag="$PROJECT_VERSION"
         elif [[ "$CI_COMMIT_BRANCH" == "develop" ]]; then
            tag="latest-preview"
            versionTag="$PROJECT_VERSION-BETA-$CI_COMMIT_SHORT_SHA"
         else
            tag="$CI_COMMIT_BRANCH"
            versionTag="$PROJECT_VERSION-BETA-$CI_COMMIT_SHORT_SHA"
         fi
         echo "Running on branch '$CI_COMMIT_BRANCH': tag = $tag"
         echo "Running on branch '$CI_COMMIT_BRANCH': version = $versionTag"
      - cd $projectDir
      - >
         docker buildx build
         --platform linux/arm64/v8,linux/amd64
         --push
         -t "${registry_orbital}/${microservice_orbital}:${tag}"
         -t "${registry_orbital}/${microservice_orbital}:${versionTag}"
         .

.publish-to-docker-hub:
   extends: .publish-docker
   rules:
      -  if: $CI_PIPELINE_SOURCE == "merge_request_event"
         when: never
      -  if: ($CI_COMMIT_BRANCH == "develop" || $CI_COMMIT_BRANCH == "master")
      -  if: ($CI_COMMIT_BRANCH != "develop" && $CI_COMMIT_BRANCH != "master")
         when: manual
         allow_failure: true
   variables:
      registry_vyne: vyneco
      registry_orbital: orbitalhq

.publish-to-gitlab-container-registry:
   extends: .publish-docker
   variables:
      registry_vyne: $CI_REGISTRY_IMAGE
      registry_orbital: $CI_REGISTRY_IMAGE
   before_script:
      - echo "$CI_REGISTRY_PASSWORD" | docker login --username $CI_REGISTRY_USER --password-stdin $CI_REGISTRY

publish-orbital-to-docker-hub:
   extends: .publish-to-docker-hub
   variables:
      projectDir: vyne-query-service
      microservice_vyne: vyne
      microservice_orbital: orbital
   before_script:
      - mkdir -p station/target/classes
      - cp -a vyne-query-service/target/classes/static/. station/target/classes/static

#publish-cask-to-docker-hub:
#   extends: .publish-to-docker-hub
#   variables:
#      projectDir: cask
#      microservice_vyne: cask
#      microservice_orbital: cask

publish-pipeline-jet-to-docker-hub:
   extends: .publish-to-docker-hub
   variables:
      projectDir: pipelines/pipeline-jet
      microservice_vyne: pipeline
      microservice_orbital: pipelines

publish-query-node-to-docker-hub:
   extends: .publish-to-docker-hub
   variables:
      projectDir: query-node-native
      microservice_vyne: query-node
      microservice_orbital: query-node

publish-schema-server-to-docker-hub:
   extends: .publish-to-docker-hub
   variables:
      projectDir: schema-server
      microservice_vyne: schema-server
      microservice_orbital: schema-server

publish-analytics-server-to-docker-hub:
   extends: .publish-to-docker-hub
   variables:
      projectDir: vyne-analytics-server
      microservice_vyne: analytics-server
      microservice_orbital: analytics-server

publish-vyne-to-gitlab-container-registry:
   extends: .publish-to-gitlab-container-registry
   variables:
      projectDir: vyne-query-service
      microservice_vyne: vyne
      microservice_orbital: orbital

publish-schema-server-to-gitlab-container-registry:
   extends: .publish-to-gitlab-container-registry
   variables:
      projectDir: schema-server
      microservice_vyne: schema-server
      microservice_orbital: schema-server

#publish-voyager-to-gitlab-container-registry:
#   extends: .publish-to-gitlab-container-registry
#   variables:
#      projectDir: voyager
#      microservice_vyne: voyager
#      microservice_orbital: voyager
#   when: manual

.publish-docker-gitlab:
   image: ${CI_DEPENDENCY_PROXY_GROUP_IMAGE_PREFIX}/jdrouet/docker-with-buildx:20.10.8-0.6.3
   stage: publish
   except:
      - tags
   variables:
      DOCKER_BUILDKIT: 1
      BUILDKIT_PROGRESS: plain
      PROGRESS_NO_TRUNC: 1
   before_script:
      - docker info
      - docker buildx create --use
      - docker login -u vynecd -p $DOCKER_HUB_PASSWORD
      - echo "$CI_REGISTRY_PASSWORD" | docker login --username $CI_REGISTRY_USER --password-stdin $CI_REGISTRY
      - |
         if [[ "$CI_COMMIT_BRANCH" == "$CI_DEFAULT_BRANCH" ]]; then
           tag="latest"
         else
           tag="$CI_COMMIT_REF_SLUG"
         fi
         echo "Running on branch '$CI_COMMIT_BRANCH': tag = $tag"
   script:
      - cd $projectDir
      - pwd
      - >
         docker buildx build
         --platform linux/arm64/v8,linux/amd64
         --push
         -t "${CI_REGISTRY}/vyne/vyne/${microservice}:${tag}"
         -t "${CI_REGISTRY}/vyne/vyne/${microservice}:${CI_COMMIT_SHORT_SHA}" .

publish-pipelines-to-gitlab-container-registry:
   extends: .publish-to-gitlab-container-registry
   variables:
      projectDir: pipelines/pipeline-jet
      microservice_vyne: pipeline
      microservice_orbital: pipelines

terraform-validate:
   extends: .terraform:validate
   needs: [ ]
   stage: build

build-helm:
   stage: build
   image:
      name: ${CI_DEPENDENCY_PROXY_GROUP_IMAGE_PREFIX}/alpine/helm:3.11.1
      entrypoint: [ "" ]
   script:
      - cd ${CI_PROJECT_DIR}/infra/helm/vyne-helm
      - helm package .
      - helm repo index .
      - cp *.tgz charts
      - cp artifacthub-repo.yml index.yaml charts
   artifacts:
      paths:
         - infra/helm/vyne-helm/charts

.terraform-deploy:
  extends: .terraform:deploy
  stage: deploy
  before_script:
     - echo ${TF_ROOT}
     - cd ${TF_ROOT}
     - gitlab-terraform plan
     - gitlab-terraform plan-json
#
#terraform-deploy-dev:
#   extends: .terraform-deploy
#   stage: deploy
#   environment:
#      name: $TF_STATE_NAME_DEV
#   variables:
#      TF_ROOT: ${CI_PROJECT_DIR}/infra/terraform/environments/$TF_STATE_NAME_DEV
#      TF_STATE_NAME: $TF_STATE_NAME_DEV
#      TF_VAR_environment: $TF_STATE_NAME_DEV
#   rules:
#      -  if: $CI_COMMIT_BRANCH == "develop"
#         when: manual
#      -  if: $CI_PIPELINE_SOURCE == "merge_request_event"
#         when: never
#

#terraform-deploy-prod:
#   extends: .terraform-deploy
#   stage: deploy
#   environment:
#      name: $TF_STATE_NAME_PROD
#   variables:
#      TF_ROOT: ${CI_PROJECT_DIR}/infra/terraform/environments/$TF_STATE_NAME_PROD
#      TF_STATE_NAME: $TF_STATE_NAME_PROD
#      TF_VAR_environment: $TF_STATE_NAME_PROD
#   rules:
#      -  if: $CI_COMMIT_BRANCH == "main"

.e2e-tests:
   stage: verify
   #   Disabling e2e tests for a bit.
   when: manual
   image: ${CI_DEPENDENCY_PROXY_GROUP_IMAGE_PREFIX}/docker:23.0.1
   tags:
      - docker-heavy
   #   retry: 2
   before_script:
      - docker login -u vynecd -p $DOCKER_HUB_PASSWORD
      - PROJECT_VERSION=$(cat build-version.txt)
      - |
         if [[ "$CI_COMMIT_BRANCH" == "master" ]]; then
           tag="latest"
           versionTag="$PROJECT_VERSION"
         elif [[ "$CI_COMMIT_BRANCH" == "develop" ]]; then
            tag="latest-preview"
            versionTag="$PROJECT_VERSION-BETA-$CI_COMMIT_SHORT_SHA"
         else
            tag="$CI_COMMIT_BRANCH"
            versionTag="$PROJECT_VERSION-BETA-$CI_COMMIT_SHORT_SHA"
         fi
         echo "Running on branch '$CI_COMMIT_BRANCH': tag = $tag"
         echo "Running on branch '$CI_COMMIT_BRANCH': version = $versionTag"
      - cd e2e-tests/
      - docker build -t e2e .
   script:
      - cd demos/
      - mkdir -p vyne/schema-server/projects
      - mkdir -p vyne/config
      - wget https://gitlab.com/vyne/demos/-/raw/master/films/docker-compose.yml
      - wget https://gitlab.com/vyne/demos/-/raw/master/films/docker/schema-server/schema-server.conf -P vyne/schema-server
      - wget https://gitlab.com/vyne/demos/-/raw/master/films/docker/schema-server/projects/taxi.conf -P vyne/schema-server/projects
      - wget https://gitlab.com/vyne/demos/-/raw/master/films/services.conf -P vyne/config
      - |
         VYNE_VERSION=$versionTag \
            docker compose -f docker-compose.yml -f e2e.docker-compose.yml up --exit-code-from e2e

e2e-tests-master:
   extends: .e2e-tests
   only:
      - master
   needs:
      - build-jvm-master
      - publish-vyne-to-gitlab-container-registry
      - publish-schema-server-to-gitlab-container-registry
   dependencies:
      - build-jvm-master

e2e-tests-develop:
   extends: .e2e-tests
   only:
      - develop
   needs:
      - build-jvm-develop
      - publish-vyne-to-gitlab-container-registry
      - publish-schema-server-to-gitlab-container-registry
   dependencies:
      - build-jvm-develop

e2e-tests-other-branches:
   extends: .e2e-tests
   except:
      - develop
      - master
   needs:
      - build-jvm-branch
      - publish-vyne-to-gitlab-container-registry
      - publish-schema-server-to-gitlab-container-registry
   dependencies:
      - build-jvm-branch

#terraform-deploy-dev-voyager:
#   extends: .terraform-deploy
#   stage: deploy
#   environment:
#      name: $TF_STATE_NAME_DEV
#   variables:
#      TF_ROOT: ${CI_PROJECT_DIR}/voyager/terraform/environments/$TF_STATE_NAME_DEV
#      TF_STATE_NAME: taxi_playground_$TF_STATE_NAME_DEV
#      TF_VAR_environment: $TF_STATE_NAME_DEV
#      TF_VAR_taxi_playground_docker_image_id: $CI_COMMIT_SHORT_SHA
#   rules:
#      -  if: $CI_COMMIT_BRANCH == "develop"
#         when: 'always'
#      -  if: $CI_COMMIT_BRANCH == "master"
#         when: 'never'
#      -  if: $CI_PIPELINE_SOURCE == "merge_request_event"
#         when: 'never'
#
#terraform-deploy-prod-voyager:
#   extends: .terraform-deploy
#   stage: deploy
#   environment:
#      name: $TF_STATE_NAME_PROD
#   variables:
#      TF_ROOT: ${CI_PROJECT_DIR}/voyager/terraform/environments/$TF_STATE_NAME_PROD
#      TF_STATE_NAME: taxi_playground_$TF_STATE_NAME_PROD
#      TF_VAR_environment: $TF_STATE_NAME_PROD
#      TF_VAR_taxi_playground_docker_image_id: $CI_COMMIT_SHORT_SHA
#   rules:
#      -  if: $CI_COMMIT_BRANCH == "develop"
#         when: 'manual'
#      -  if: $CI_COMMIT_BRANCH == "master"
#         when: 'always'
#      -  if: $CI_PIPELINE_SOURCE == "merge_request_event"
#         when: 'never'

terraform-deploy-dev-voyager:
   extends: .terraform-deploy
   stage: deploy
   environment:
      name: $TF_STATE_NAME_DEV
   variables:
      TF_ROOT: ${CI_PROJECT_DIR}/voyager/terraform/environments/orbital_$TF_STATE_NAME_DEV
      TF_STATE_NAME: voyager_$TF_STATE_NAME_DEV
      TF_VAR_environment: $TF_STATE_NAME_DEV
      TF_VAR_taxi_playground_docker_image_id: $CI_COMMIT_SHORT_SHA
   when: manual

terraform-deploy-prod-voyager:
   extends: .terraform-deploy
   stage: deploy
   environment:
      name: $TF_STATE_NAME_PROD
   variables:
      TF_ROOT: ${CI_PROJECT_DIR}/voyager/terraform/environments/orbital_$TF_STATE_NAME_PROD
      TF_STATE_NAME: voyager_$TF_STATE_NAME_PROD
      TF_VAR_environment: $TF_STATE_NAME_PROD
      TF_VAR_taxi_playground_docker_image_id: $CI_COMMIT_SHORT_SHA
   when: manual

publish-snyk-to-gitlab-container-registry:
   extends: .publish-to-gitlab-container-registry
   script:
      - cd snyk/
      - echo "$CI_REGISTRY_PASSWORD" | docker login --username $CI_REGISTRY_USER --password-stdin $CI_REGISTRY
      - docker build -t "${registry_orbital}/snyk:latest" .
      - docker push ${registry_orbital}/snyk:latest

.snyk:
   stage: verify
   image: $CI_REGISTRY_IMAGE/snyk:latest
   only:
      - develop
   when: manual
   variables:
      SNYK_TOKEN: ea48d8a0-a809-4381-97cb-e54c20a21ad1 # TODO This won't be picked up unless explicitly specified here?
   before_script:
      - echo "$CI_REGISTRY_PASSWORD" | docker login --username $CI_REGISTRY_USER --password-stdin $CI_REGISTRY
      - snyk auth $SNYK_TOKEN
      - PROJECT_VERSION=$(cat build-version.txt)
      - |
         if [[ "$CI_COMMIT_BRANCH" == "master" ]]; then
           tag="latest"
           versionTag="$PROJECT_VERSION"
         elif [[ "$CI_COMMIT_BRANCH" == "develop" ]]; then
            tag="latest-preview"
            versionTag="$PROJECT_VERSION-BETA-$CI_COMMIT_SHORT_SHA"
         else
            tag="$CI_COMMIT_BRANCH"
            versionTag="$PROJECT_VERSION-BETA-$CI_COMMIT_SHORT_SHA"
         fi
         echo "Running on branch '$CI_COMMIT_BRANCH': tag = $tag"
         echo "Running on branch '$CI_COMMIT_BRANCH': version = $versionTag"
   script:
      - snyk container test --app-vulns ${CI_REGISTRY_IMAGE}/$image:$versionTag --severity-threshold=high

snyk-schema-server:
   extends: .snyk
   dependencies:
      - publish-schema-server-to-gitlab-container-registry
      - build-jvm-develop
   variables:
      image: schema-server

snyk-query-server:
   extends: .snyk
   dependencies:
      - publish-vyne-to-gitlab-container-registry
      - build-jvm-develop
   variables:
      image: vyne

snyk-pipelines:
   extends: .snyk
   dependencies:
      - publish-pipelines-to-gitlab-container-registry
      - build-jvm-develop
   variables:
      image: pipelines
