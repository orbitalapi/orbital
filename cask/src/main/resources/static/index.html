<!doctype html>
<html lang="en">
<head>
   <!-- Required meta tags -->
   <meta charset="utf-8">
   <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

   <!-- Bootstrap CSS -->
   <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
         integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">

   <title>Cask testharness page</title>
</head>
<body>
<div class="container">
   <h1>Cask testharness page</h1>
   <div class="form-group">
      <label for="caskUrl">Cask URL</label>
      <input class="form-control" id="caskUrl" rows="3"></input>
   </div>
   <button type="submit" class="btn btn-primary" id="connectToCaskButton">Connect</button>
   <br/><br/>

   <div class="form-group">
      <label for="inputMessage">Input message</label>
      <textarea class="form-control" id="inputMessage" rows="3"></textarea>
   </div>
   <button type="submit" class="btn btn-primary" id="sendToCaskButton">Send</button>
   <br/><br/>

   <div class="form-group">
      <label for="caskResponse">Responses</label>
      <textarea class="form-control" id="caskResponse" rows="20"></textarea>
   </div>
</div>

<script src="https://code.jquery.com/jquery-3.4.1.slim.min.js"
        integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n"
        crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
        integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo"
        crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"
        integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6"
        crossorigin="anonymous"></script>
<script>
   var caskUrl = "ws://localhost:8800/cask/json/cacib.cemafor.orders.Order";
   var clientWebSocket;
   var message = JSON.stringify({
   "tradeNumber":"USDINFLA-2020-05-05T09:10:54.1826197Z",
   "eventType":"Open",
   "tradeVersion":1,
   "rfqId":"RfqId",
   "entryType":"WithHeld",
   "time":"2019-12-03 16:07:59.7980000",
   "securityType":"Bond",
   "subSecurityType":"??",
   "identifierCode":"Identifier Code",
   "identifierValue":"???",
   "securityDescription":"Security Description",
   "price":{
      "currency":"EUR",
      "amount":10.7

},
   "buySellFlag":"Buys",
   "exchange":"CEM0",
   "trader":"Trader 001",
   "maturityDate":"2019-12-03",
   "startDate":"2019-12-03",
   "counterParty1":"PlacingCounterpartyName",
   "counterParty2":"CounterpartyName",
   "sourceSystem":"SourceSystemName",
   "brokerFee":1.07,
   "leg1Currency":"USD",
   "leg1DayCountFraction":"ThirtyOverThreeSixty",
   "leg1NotionalValue":1700000,
   "leg1PaymentFrequency":0.78,
   "leg1Rate":0.00995,
   "leg1RateSpread": 1,
   "leg1ResetFrequency": 1,
   "leg2Currency":"USD",
   "leg2DayCountFraction":"ActOverThreeSixFixFiveL",
   "leg2NotionalValue":1700000,
   "leg2PaymentFrequency":0.55,
   "leg2Rate": 0.95,
   "leg2RateSpread": 1,
   "leg2ResetFrequency": 2,
   "tenorMultiplier":2,
   "tenorPeriod":"W",
   "fixedLegMultiplier":2,
   "fixedLegPeriod":"W",
   "floatingRateIndex":"Libor",
   "notionalExchange": 10
})
;

   function connectToCask(url) {
      clientWebSocket = new WebSocket(url);
      clientWebSocket.onopen = function () {
         console.log("clientWebSocket.onopen", clientWebSocket);
         console.log("clientWebSocket.readyState", "websocketstatus");
         logMessage("Connected to " + url);
      }
      clientWebSocket.onclose = function (closeEvent) {
         console.log("clientWebSocket.onclose", clientWebSocket);
         console.log(closeEvent);
         logMessage("Closing websocket connection code=" + closeEvent.code + " reason=" + closeEvent.reason);
      }
      clientWebSocket.onerror = function (error) {
         console.log("clientWebSocket.onerror", clientWebSocket, error);
         logMessage("An error occured");
         logMessage(error)
      }
      clientWebSocket.onmessage = function (error) {
         console.log("clientWebSocket.onmessage", clientWebSocket, error);
         logMessage(error.data);
      }
      return clientWebSocket;
   }

   function logMessage(responseEvent) {
      console.log("Message");
      console.log(responseEvent);
      if (typeof responseEvent === 'object' && responseEvent !== null) {
         document.getElementById("caskResponse").innerHTML = JSON.stringify(responseEvent) + '\n' + document.getElementById("caskResponse").innerHTML;
      } else {
         document.getElementById("caskResponse").innerHTML = responseEvent + '\n' + document.getElementById("caskResponse").innerHTML;
      }
   }

   $(document).ready(function () {
      $("#inputMessage").append(JSON.stringify(message));
      $("#caskUrl").val(caskUrl);
      $("#sendToCaskButton").click(function () {
         clientWebSocket.send($("#inputMessage").val());
      });
      $("#connectToCaskButton").click(function () {
         var url = encodeURI($("#caskUrl").val());
         connectToCask(url);
      });
   });
</script>
</body>
</html>
